<!DOCTYPE html>
<html>
<head>

<!-- Add jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Add Select2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <title>Action Step Chart</title>
    <title>CA/PA Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        h1 {
            color: #1f3b4d;
        }
        .chart-container {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            background: white;
            padding: 20px;
            border-radius: 12px;
        }
    </style>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f8f9fa;
    }

    .dashboard-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      gap: 40px;
      flex-wrap: wrap;
    }

    .left-section {
      flex: 1;
      min-width: 300px;
    }

    .right-section {
      width: 300px;
      min-width: 250px;
    }

    .section-header {
      font-size: 1.0rem;
      margin-top: 30px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #343a40;
    }

    .info-table {
      width: auto;
      max-width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      background-color: #D9E1F2;
      table-layout: auto;
    }

    .info-table th,
    .info-table td {
      padding: 12px 16px;
      border: 1px solid #070707;
      text-align: left;
      white-space: nowrap;
    }

    .info-table th {
      background-color: #305496;
      font-weight: 600;
      color: #dee2e6;
    }

    .info-table td strong {
      color: #212529;
    }

    .table-wrapper {
      overflow-x: auto;
    }
      .select2-results__option--selected::before {
    content: "✔ ";
    color: black;
    font-weight: bold;
    margin-right: 5px;
  }
  </style>
</head>
<body>
<form method="POST">

  <div class="d-flex justify-content-between flex-wrap gap-4">

    <!-- STATUS FILTER -->
    <div>
      <label>Status Filter:</label><br>
      <select name="Status" multiple id="status-select" style="width: 250px;">
        {% for item in status_options %}
        <option value="{{ item }}" {% if item in selected_statuses %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- AUDIT FILTER (CENTER) -->
    <div class="text-center">
      <label>Audit Filter:</label><br>
      <select name="Audit" multiple id="audit-select" style="width: 250px;">
        {% for item in audit_options %}
        <option value="{{ item }}" {% if item in selected_audits %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- SOURCE FILTER (RIGHT) -->
    <div class="text-end">
      <label>Source Filter:</label><br>
      <select name="Source" multiple id="source-select" style="width: 250px;">
        {% for item in source_options %}
        <option value="{{ item }}" {% if item in selected_sources %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </div>
    <!-- CA_PA FILTER (Below Source) -->
    <div class="text-end">
      <label>CA/PA Filter:</label><br>
      <select name="CA_PA" multiple id="capa-select" style="width: 250px;" data-placeholder="Select">
        {% for item in ca_pa_options %}
        <option value="{{ item }}" {% if item in selected_ca_pa %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </div>

  </div>
    
    <br><br>


    <br><br>

    <label>Rised date:</label>
    <input type="date" name="start_date" value="{{ start_date }}">

    <label>End Date:</label>
    <input type="date" name="end_date" value="{{ end_date }}">

    <br><br>
    <button type="submit">Apply Filters</button>
</form>

<hr>

<div>
    {{ plot | safe }}
</div>
<br>
  <div class="dashboard-container">
    <!-- LEFT CONTENT -->
    <div class="left-section">

      <!-- CA/PA Information Table -->
      <div class="section-header">STATUS BY ACTION</div>
      <table class="info-table">
        <tr><th>Category</th><th>Count</th></tr>
        <tr><td>Open</td><td><strong>{{ total }}</strong></td></tr>
        <tr><td>New</td><td><strong>{{ new }}</strong></td></tr>
        <tr><td>AHY Stage</td><td><strong>{{ ahy_capa }}</strong></td></tr>
        <tr><td>SCAA Stage</td><td><strong>{{ scaa_capa }}</strong></td></tr>
      </table>

      <!-- CA/PA Due Status Table -->
      <div class="section-header">CA/PA DUE STATUS</div>
      <table class="info-table">
        <tr><th>Category</th><th>Count</th><th>CA/PA</th></tr>
        <tr><td>Overdue</td><td><strong>{{ overdue }}</strong></td><td><strong>{{ capa_ovedue }}</strong></td></tr>
        <tr><td>Due in 3 Days</td><td><strong>{{ due_3 }}</strong></td><td><strong>{{ capa_less_3_days }}</strong></td></tr>
        <tr><td>Due 3–7 Days</td><td><strong>{{ due_3_7 }}</strong></td><td><strong>{{ capa_3_7_days }}</strong></td></tr>
        <tr><td>Due > 7 Days</td><td><strong>{{ due_7_more }}</strong></td><td><strong>{{ capa_more_7_days }}</strong></td></tr>
  
      </table>

    </div>

    <!-- RIGHT CONTENT (Summary) -->
    <div class="right-section">
      <div class="section-header">SUMMARY STATUS</div>
      <table class="info-table">
        <tr><th>Category</th><th>Count</th></tr>
        <tr><td>Total</td><td><strong>{{ total_full }}</strong></td></tr>
        <tr><td>Open</td><td><strong>{{ total_open }}</strong></td></tr>
        <tr><td>Closed</td><td><strong>{{ total_closed }}</strong></td></tr>
        <tr><td>Pending</td><td><strong>{{ total_pending }}</strong></td></tr>
      </table>
    </div>
  </div>

  <!-- CA/PA Table View -->
  <div class="section-header">CA/PA STAGES DUE STATUS</div>
  <div class="table-wrapper">
    <table class="info-table text-center">
      <thead>
        <tr>
          {% for col in columns %}
            <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in data %}
          <tr>
            {% for cell in row %}
              <td>{{ cell }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<br>

<div>
    {{ plot_pie | safe }}
</div>


<br>

<div>
    {{ plot_scater | safe }}
</div>


<div>
    {{ plot_audit | safe }}
</div>

<br>
  <!-- CA/PA Table View -->
  <div class="section-header">Audit STATUS</div>
  <div class="table-wrapper">
    <table class="info-table text-center">
      <thead>
        <tr>
          {% for col in columns1 %}
            <th>{{ col }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in data1 %}
          <tr>
            {% for cell in row %}
              <td>{{ cell }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


<script>
  $(document).ready(function() {
    $('#status-select').select2({
      placeholder: "Select Status",
      allowClear: true
    });
    $('#audit-select').select2({
      placeholder: "Select Audit",
      allowClear: true
    });
    $('#source-select').select2({
      placeholder: "Select Source",
      allowClear: true
    });
  $(document).ready(function () {
    const $select = $('#capa-select');

    $select.select2({
      placeholder: "Select",
      closeOnSelect: false,
      allowClear: true,
      templateSelection: function () {
        return ''; // Hide selected text
      }
    });

    $select.on('select2:select', function (e) {
      if (e.params.data.id === 'select_all') {
        // Select all except "Select All"
        let allValues = [];
        $('#capa-select option').each(function () {
          if (this.value !== 'select_all') {
            allValues.push(this.value);
          }
        });
        $select.val(allValues).trigger('change');
      }
    });

    $select.on('select2:unselect', function (e) {
      if (e.params.data.id === 'select_all') {
        // Unselect all if "Select All" is unselected
        $select.val(null).trigger('change');
      }
    });
  });
  });
</script>
</html>
